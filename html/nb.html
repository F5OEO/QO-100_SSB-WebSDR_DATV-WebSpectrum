<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="pcmplayer.js"></script>
        <style>

body { 
  font-family: Helvetica, Arial, Geneva, sans-serif;
}

.leftside
{
    width: 620px;
    background-color: #f0f0f0;
}

.rl_space
{
    width: 10px;
    background-color: #ffffff;
}

.midside
{
    width: 560px;
    background-color: #f0f0f0;
}

.rightside
{
    width: 300px;
    background-color: #f0f0f0;
}

.rightrow
{
    font-size:20px;
    font-weight: 500;
    width: 570px;
    display: flex;
}

.rightrow_space
{
    width: 570px;
    height: 10px;
}

.rightcell_label
{
    width: 100px;
}

.rightcell_label_header
{
    width: 570px;
    font-weight: 600;
}

.rightcell_slider
{
    width: 185px;
}

.controls 
{
    width: 1500px;
    display: flex;
    background-color: #e0e0e0;
}

.controls_left
{
    width: 630px;
    display: flex;
}

.controls_left_left
{
    font-size:16px;
    width: 150px;
    color: blue;
    font-weight: 600;
}

.controls_left_mid
{
    font-size:16px;
    width: 200px;
    color: blue;
    font-weight: 600;
}

.controls_left_right
{
    font-size:14px;
    width: 280px;
    color: blue;
    font-weight: 600;
}

.header_mytitle
{
    font-size:30px;
    color: white;
    background-color:#808080;
    width: 1500px;
    text-align: center;
    font-weight: 900;
}

.header_subtitle
{
    font-size:20px;
    color: white;
    background-color:#808080;
    width: 1500px;
    text-align: center;
}

.tuneinfo
{
    font: "Arial";
    font-size:26px;
    font-weight: 600;
    color: blue;
    width: 1500px;
    text-align: center;
}

.selectbox {
    width: 120px;
    padding:6px;
    margin-top: 6px;
    -webkit-border-radius:4px;
    -moz-border-radius:4px;
    border-radius:4px;
    background: #e8e8e8;
    color:#404040;
    outline:none;
    display: inline-block;
    -webkit-appearance:none;
    -moz-appearance:none;
    appearance:none;
    cursor:pointer;
    font-size: 16px;
    font-weight: 600;
}

.mybutton {
    width:99px;
    padding: 1px;
    margin-top: 3px;
    margin-bottom: 3px;
    -webkit-border-radius:4px;
    -moz-border-radius:4px;
    border-radius:4px;
    background: #c8c8e8;
    color:#404040;
    outline:none;
    display: inline-block;
    -webkit-appearance:none;
    -moz-appearance:none;
    appearance:none;
    cursor:pointer;
    font-size: 16px;
    font-weight: 600;
}

.qrg {
width:100px;
}

canvas {
    display:block;
    margin: -2px;
}


</style>

<script type="text/javascript">
/*
QO-100 Java Script
by DJ0ABR, Kurt Moraw
*/
var coltab = [
[0.0,0.0,0.0],
[0.6,0.9,1.0],
[0.0,0.0,1.0],
[0.0157,0.0,0.0],
[0.0235,0.0,0.0],
[0.0314,0.0,0.0],
[0.0392,0.0,0.0],
[0.0471,0.0,0.0],
[0.0549,0.0,0.0],
[0.0627,0.0,0.0],
[0.0706,0.0,0.0],
[0.0784,0.0,0.0],
[0.0863,0.0,0.0],
[0.0941,0.0,0.0],
[0.1020,0.0,0.0],
[0.1098,0.0,0.0],
[0.1176,0.0,0.0],
[0.1255,0.0,0.0],
[0.1333,0.0,0.0],
[0.1412,0.0,0.0],
[0.1490,0.0,0.0],
[0.1569,0.0,0.0],
[0.1647,0.0,0.0],
[0.1725,0.0,0.0],
[0.1804,0.0,0.0],
[0.1882,0.0,0.0],
[0.1961,0.0,0.0],
[0.2039,0.0,0.0],
[0.2118,0.0,0.0],
[0.2196,0.0,0.0],
[0.2275,0.0,0.0],
[0.2353,0.0,0.0],
[0.2431,0.0,0.0],
[0.2510,0.0,0.0],
[0.2588,0.0,0.0],
[0.2667,0.0,0.0],
[0.2745,0.0,0.0],
[0.2824,0.0,0.0],
[0.2902,0.0,0.0],
[0.2980,0.0,0.0],
[0.3059,0.0,0.0],
[0.3137,0.0,0.0],
[0.3216,0.0,0.0],
[0.3294,0.0,0.0],
[0.3373,0.0,0.0],
[0.3451,0.0,0.0],
[0.3529,0.0,0.0],
[0.3608,0.0,0.0],
[0.3686,0.0,0.0],
[0.3765,0.0,0.0],
[0.3843,0.0,0.0],
[0.3922,0.0,0.0],
[0.4000,0.0,0.0],
[0.4078,0.0,0.0],
[0.4157,0.0,0.0],
[0.4235,0.0,0.0],
[0.4314,0.0,0.0],
[0.4392,0.0,0.0],
[0.4471,0.0,0.0],
[0.4549,0.0,0.0],
[0.4627,0.0,0.0],
[0.4706,0.0,0.0],
[0.4784,0.0,0.0],
[0.4863,0.0,0.0],
[0.4941,0.0,0.0],
[0.5020,0.0,0.0],
[0.5098,0.0098,0.0],
[0.5176,0.0176,0.0],
[0.5255,0.0255,0.0],
[0.5333,0.0333,0.0],
[0.5412,0.0412,0.0],
[0.5490,0.0490,0.0],
[0.5569,0.0569,0.0],
[0.5647,0.0647,0.0],
[0.5725,0.0725,0.0],
[0.5804,0.0804,0.0],
[0.5882,0.0882,0.0],
[0.5961,0.0961,0.0],
[0.6039,0.1039,0.0],
[0.6118,0.1118,0.0],
[0.6196,0.1196,0.0],
[0.6275,0.1275,0.0],
[0.6353,0.1353,0.0],
[0.6431,0.1431,0.0],
[0.6510,0.1510,0.0],
[0.6588,0.1588,0.0],
[0.6667,0.1667,0.0],
[0.6745,0.1745,0.0],
[0.6824,0.1824,0.0],
[0.6902,0.1902,0.0],
[0.6980,0.1980,0.0],
[0.7059,0.2059,0.0],
[0.7137,0.2137,0.0],
[0.7216,0.2216,0.0],
[0.7294,0.2294,0.0],
[0.7373,0.2373,0.0],
[0.7451,0.2451,0.0],
[0.7529,0.2529,0.0],
[0.7608,0.2608,0.0],
[0.7686,0.2686,0.0],
[0.7765,0.2765,0.0],
[0.7843,0.2843,0.0],
[0.7922,0.2922,0.0],
[0.8000,0.3001,0.0],
[0.8078,0.3078,0.0],
[0.8157,0.3157,0.0],
[0.8235,0.3235,0.0],
[0.8314,0.3314,0.0],
[0.8392,0.3392,0.0],
[0.8471,0.3471,0.0],
[0.8549,0.3549,0.0],
[0.8627,0.3627,0.0],
[0.8706,0.3706,0.0],
[0.8784,0.3784,0.0],
[0.8863,0.3863,0.0],
[0.8941,0.3941,0.0],
[0.9020,0.4020,0.0],
[0.9098,0.4098,0.0],
[0.9176,0.4176,0.0],
[0.9255,0.4255,0.0],
[0.9333,0.4333,0.0],
[0.9412,0.4412,0.0],
[0.9490,0.4490,0.0],
[0.9569,0.4569,0.0],
[0.9647,0.4647,0.0],
[0.9725,0.4725,0.0],
[0.9804,0.4804,0.0],
[0.9882,0.4882,0.0],
[0.9961,0.4961,0.0],
[1.0000,0.5039,0.0],
[1.0000,0.5118,0.0118],
[1.0000,0.5196,0.0196],
[1.0000,0.5275,0.0275],
[1.0000,0.5353,0.0353],
[1.0000,0.5431,0.0431],
[1.0000,0.5510,0.0510],
[1.0000,0.5588,0.0588],
[1.0000,0.5667,0.0667],
[1.0000,0.5745,0.0745],
[1.0000,0.5824,0.0824],
[1.0000,0.5902,0.0902],
[1.0000,0.5980,0.0980],
[1.0000,0.6059,0.1059],
[1.0000,0.6137,0.1137],
[1.0000,0.6216,0.1216],
[1.0000,0.6294,0.1294],
[1.0000,0.6373,0.1373],
[1.0000,0.6451,0.1451],
[1.0000,0.6529,0.1529],
[1.0000,0.6608,0.1608],
[1.0000,0.6686,0.1686],
[1.0000,0.6765,0.1765],
[1.0000,0.6843,0.1843],
[1.0000,0.6922,0.1922],
[1.0000,0.7000,0.2000],
[1.0000,0.7078,0.2078],
[1.0000,0.7157,0.2157],
[1.0000,0.7235,0.2235],
[1.0000,0.7314,0.2314],
[1.0000,0.7392,0.2392],
[1.0000,0.7471,0.2471],
[1.0000,0.7549,0.2549],
[1.0000,0.7627,0.2627],
[1.0000,0.7706,0.2706],
[1.0000,0.7784,0.2784],
[1.0000,0.7863,0.2863],
[1.0000,0.7941,0.2941],
[1.0000,0.8020,0.3020],
[1.0000,0.8098,0.3098],
[1.0000,0.8176,0.3176],
[1.0000,0.8255,0.3255],
[1.0000,0.8333,0.3333],
[1.0000,0.8412,0.3412],
[1.0000,0.8490,0.3490],
[1.0000,0.8569,0.3569],
[1.0000,0.8647,0.3647],
[1.0000,0.8725,0.3725],
[1.0000,0.8804,0.3804],
[1.0000,0.8882,0.3882],
[1.0000,0.8961,0.3961],
[1.0000,0.9039,0.4039],
[1.0000,0.9118,0.4118],
[1.0000,0.9196,0.4196],
[1.0000,0.9275,0.4275],
[1.0000,0.9353,0.4353],
[1.0000,0.9431,0.4431],
[1.0000,0.9510,0.4510],
[1.0000,0.9588,0.4588],
[1.0000,0.9667,0.4667],
[1.0000,0.9745,0.4745],
[1.0000,0.9824,0.4824],
[1.0000,0.9902,0.4902],
[1.0000,0.9980,0.4980],
[1.0000,1.0000,0.5059],
[1.0000,1.0000,0.5137],
[1.0000,1.0000,0.5216],
[1.0000,1.0000,0.5294],
[1.0000,1.0000,0.5373],
[1.0000,1.0000,0.5451],
[1.0000,1.0000,0.5529],
[1.0000,1.0000,0.5608],
[1.0000,1.0000,0.5686],
[1.0000,1.0000,0.5765],
[1.0000,1.0000,0.5843],
[1.0000,1.0000,0.5922],
[1.0000,1.0000,0.6000],
[1.0000,1.0000,0.6078],
[1.0000,1.0000,0.6157],
[1.0000,1.0000,0.6235],
[1.0000,1.0000,0.6314],
[1.0000,1.0000,0.6392],
[1.0000,1.0000,0.6471],
[1.0000,1.0000,0.6549],
[1.0000,1.0000,0.6627],
[1.0000,1.0000,0.6706],
[1.0000,1.0000,0.6784],
[1.0000,1.0000,0.6863],
[1.0000,1.0000,0.6941],
[1.0000,1.0000,0.7020],
[1.0000,1.0000,0.7098],
[1.0000,1.0000,0.7176],
[1.0000,1.0000,0.7255],
[1.0000,1.0000,0.7333],
[1.0000,1.0000,0.7412],
[1.0000,1.0000,0.7490],
[1.0000,1.0000,0.7569],
[1.0000,1.0000,0.7647],
[1.0000,1.0000,0.7725],
[1.0000,1.0000,0.7804],
[1.0000,1.0000,0.7882],
[1.0000,1.0000,0.7961],
[1.0000,1.0000,0.8039],
[1.0000,1.0000,0.8118],
[1.0000,1.0000,0.8196],
[1.0000,1.0000,0.8275],
[1.0000,1.0000,0.8353],
[1.0000,1.0000,0.8431],
[1.0000,1.0000,0.8510],
[1.0000,1.0000,0.8588],
[1.0000,1.0000,0.8667],
[1.0000,1.0000,0.8745],
[1.0000,1.0000,0.8824],
[1.0000,1.0000,0.8902],
[1.0000,1.0000,0.8980],
[1.0000,1.0000,0.9059],
[1.0000,1.0000,0.9137],
[1.0000,1.0000,0.9216],
[1.0000,1.0000,0.9294],
[1.0000,1.0000,0.9373],
[1.0000,1.0000,0.9451],
[1.0000,1.0000,0.9529],
[1.0000,1.0000,0.9608],
[1.0000,1.0000,0.9686],
[1.0000,1.0000,0.9765],
//[ 1.0,0.0,0.0],
//[ 1.0,0.0,0.0]
[ 1.0,1.0,1.0],
[ 1.0,1.0,1.0]
];
            
            window.onload = onstart;
            
            var intv;
            var interval;
            var sockintv;
            var sockOpen = 0;
            var websocket;

            var tunerqrg = 0;
            var end = 0;
            var tuneqrg = 0;
            var foffset = 0;
            var resolution = 1;
            var vertlines = 1;
            var vertmarker = 1;
            var ssbmode = 0;
            
            var end1 = 0;
            var tuneqrg1 = 0;
            var foffset1 = 0;
            var resolution1 = 1;
            
            var player;
            var playON = 0;
            
            function MouseMoveHandler(e)
            {
                var e = window.event || e; // old IE support
                var mval = tuneqrg/1e3 + (e.pageX * resolution)/1e6;
                mval -= 0.001200; // needed to get right value from mouse pointer, reason unknown
                $('#mousepos').html("mouse pointer: " + mval.toFixed(6) + " MHz");
            }
            
            function MouseWheelHandler(e)
            {
                // cross-browser wheel delta
                var e = window.event || e; // old IE support
                var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
                
                if(e.shiftKey == true)
                    delta *= 25;
                
                websocket.send("mousewh:"+ delta + "\0");

                return false;
            }
            
            function audioON()
            {
                if(playON == 0)
                {
                    player = new PCMPlayer({
                            encoding: '16bitInt',
                            channels: 1,
                            sampleRate: 8000,
                            flushingTime: 500
                    });
                    
                    playON = 1;
                    $("#audiobutton").html('AUDIO ON');
                }
                else if(playON == 1)
                {
                    playON = 2;
                    $("#audiobutton").html('AUDIO OFF');
                }
                else if(playON == 2)
                {
                    playON = 1;
                    $("#audiobutton").html('AUDIO ON');
                }
            }
            
            var filter_cutoff = 2400;
            
            function filter18()
            {
                websocket.send("filterw:0\0");
                filter_cutoff = 1800;
            }
            
            function filter24()
            {
                websocket.send("filterw:1\0");
                filter_cutoff = 2400;
            }
            
            function filter28()
            {
                websocket.send("filterw:2\0");
                filter_cutoff = 2800;
            }

            function filter30()
            {
                websocket.send("filterw:3\0");
                filter_cutoff = 3000;
            }

            function filter36()
            {
                websocket.send("filterw:4\0");
                filter_cutoff = 3600;
            }

            function onstart()
            {
                setListboxes();
                
                // click into WF
                document.getElementById('wf_overlay').addEventListener
                ('click',
                    function(evt){
                        var xpos = evt.clientX;
                        var rect = document.getElementById("wf_overlay").getBoundingClientRect();
                        websocket.send("mousepo:"+ (xpos - rect.left) + "\0");
                    },false
                );
                
                // mouse wheel in WF
                var myitem = document.getElementById("wf_overlay");
                if (myitem.addEventListener)
                {
                    // IE9, Chrome, Safari, Opera
                    myitem.addEventListener("mousewheel", MouseWheelHandler, false);
                    // Firefox
                    myitem.addEventListener("DOMMouseScroll", MouseWheelHandler, false);
                    
                    myitem.addEventListener("mousemove", MouseMoveHandler, false);
                }
                // IE 6/7/8
                else
                {
                    myitem.attachEvent("onmousewheel", MouseWheelHandler);
                }
                
                // click into lower WF
                document.getElementById('wf1_overly').addEventListener
                ('click',
                    function(evt){
                        var xpos = evt.clientX;
                        var rect = document.getElementById("wf_overlay").getBoundingClientRect();
                        websocket.send("mouselo:"+ (xpos - rect.left) + "\0");
                    },false
                );
                
                // mouse wheel in lower WF
                var myitem = document.getElementById("wf1_overly");
                if (myitem.addEventListener)
                {
                    // IE9, Chrome, Safari, Opera
                    myitem.addEventListener("mousewheel", MouseWheelHandler, false);
                    // Firefox
                    myitem.addEventListener("DOMMouseScroll", MouseWheelHandler, false);
                }
                // IE 6/7/8
                else
                {
                    myitem.attachEvent("onmousewheel", MouseWheelHandler);
                }

                sockintv = setInterval(checkSocket, 1000);
            }
            
            var reload = 0;
            
            function reloadData()
            {
                reload = 1;
            }
            
            var intervalset = 0;
            
            function checkSocket()
            {
                if(sockOpen == 0)
                {
                    if(websocket != null)
                        websocketclose();
                    openWebSocket();
                }
                
                showLock();
                
                // set interval to 5s, this ensures that it can reconnect 
                // if the server was down. This does not work with faster intervals
                if(intervalset == 0)
                {
                    intervalset = 1;
                    clearInterval(sockintv);
                    sockintv = setInterval(checkSocket, 5000);
                }
            }
            
            function websocketclose()
            {
                if(websocket != null)
                {
                    //console.log("close websocket");
                    websocket.close();
                    websocket = null;
                }
                else
                {
                    //console.log("close websocket, already closed");
                }
            }

            var pix = new Array();
            var pixwidth;
            
            var pix1 = new Array();
            var pixwidth1;
            
            function drawWFtitle(id,fstart, fend, resolution)
            {
                var cnv = document.getElementById(id); 
                var ctx = cnv.getContext("2d");
                var width = cnv.width;
                var height = cnv.height;
                
                ctx.font = "16px Arial";
                ctx.fillStyle = "#0000c0";
                ctx.fillRect(0,0,width,height);
                
                ctx.fillStyle = "#ffffff";
                ctx.fillText(fstart/1e3,0,16);
                
                var txt = (((fend-fstart)/4+fstart)/1e3).toFixed(6);
                ctx.fillText(txt,width/4-10,16);
                
                ctx.textAlign = "center";
                txt = (((fend-fstart)/2+fstart)/1e3).toFixed(6);
                ctx.fillText(txt,width/2,16);
                
                txt = (((fend-fstart)*3/4+fstart)/1e3).toFixed(6);
                ctx.fillText(txt,width*3/4-7,16);

                ctx.textAlign = "right";
                txt = (fend/1e3).toFixed(6);
                ctx.fillText(txt,width,16);
            }
            
            function drawWFtitle_eshail_rx(id)
            {
                var cnv = document.getElementById(id); 
                var ctx = cnv.getContext("2d");
                var width = cnv.width;
                var height = cnv.height;
                
                ctx.font = "16px Arial";
                ctx.fillStyle = "#0000c0";
                ctx.fillRect(0,0,width,height);
                
                ctx.fillStyle = "#ffffff";
                var qrg = 10489550;
                ctx.fillText(qrg/1e3,cpos(qrg)-30,16);

                var qrg = 10489600;
                ctx.fillText(qrg/1e3,cpos(qrg)-30,16);

                var qrg = 10489620;
                ctx.fillText(qrg/1e3,cpos(qrg)-30,16);

                var qrg = 10489640;
                ctx.fillText(qrg/1e3,cpos(qrg)-30,16);

                var qrg = 10489690;
                ctx.fillText(qrg/1e3,cpos(qrg)-30,16);

                var qrg = 10489800;
                ctx.fillText(qrg/1e3,cpos(qrg)-30,16);
            }
            
            function drawWFtitle_eshail_tx(id)
            {
                var cnv = document.getElementById(id); 
                var ctx = cnv.getContext("2d");
                var width = cnv.width;
                var height = cnv.height;
                
                ctx.font = "16px Arial";
                ctx.fillStyle = "#0000c0";
                ctx.fillRect(0,0,width,height);
                
                ctx.fillStyle = "#ffffff";
                var qrg = 10489550;
                ctx.fillText((qrg-8089500)/1e3,cpos(qrg)-30,16);

                var qrg = 10489600;
                ctx.fillText((qrg-8089500)/1e3,cpos(qrg)-30,16);

                var qrg = 10489620;
                ctx.fillText((qrg-8089500)/1e3,cpos(qrg)-30,16);

                var qrg = 10489640;
                ctx.fillText((qrg-8089500)/1e3,cpos(qrg)-30,16);

                var qrg = 10489690;
                ctx.fillText((qrg-8089500)/1e3,cpos(qrg)-30,16);

                var qrg = 10489800;
                ctx.fillText((qrg-8089500)/1e3,cpos(qrg)-30,16);
            }
            
            function drawWFtitle_eshail_ssb(id,qrg)
            {
                var cnv = document.getElementById(id); 
                var ctx = cnv.getContext("2d");
                var width = cnv.width;
                var height = cnv.height;
                
                ctx.font = "16px Arial";
                ctx.fillStyle = "#0000c0";
                ctx.fillRect(0,0,width,height);
                
                ctx.fillStyle = "#ffffff";
                
                ctx.textAlign = "right";
                ctx.fillText((qrg+0.0075).toFixed(6),width-1,16);
                
                ctx.textAlign = "left";
                ctx.fillText((qrg-0.0075).toFixed(6),0,16);

                ctx.textAlign = "center";
                ctx.fillText(qrg.toFixed(6),width/2,16);
            }
            
            function drawMODEtitle(id,fstart, fend, resolution)
            {
                var cnv = document.getElementById(id); 
                var ctx = cnv.getContext("2d");
                var width = cnv.width;
                var height = cnv.height;
                
                ctx.font = "16px Arial";
                // background
                ctx.fillStyle = "#0000c0";
                ctx.fillRect(0,0,width,height);
                
                // Beacons
                ctx.fillStyle = "#ff0000";
                var x1 = cpos(10489550);
                var x2 = cpos(10489555);
                ctx.fillRect(x1,0,x2-x1,20);
                
                var x1 = cpos(10489795);
                var x2 = cpos(10489800);
                ctx.fillRect(x1,0,x2-x1,20);
                
                ctx.font = "16px Arial";
                ctx.fillStyle = "#ffffff";
                ctx.fillText("B",cpos(10489551),15);
                ctx.fillText("B",cpos(10489796),15);
                
                // CW
                ctx.fillStyle = "#00afef";
                var x1 = cpos(10489555);
                var x2 = cpos(10489600);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("CW only",cpos(10489566),15);
                
                // NB digital
                ctx.fillStyle = "#6f2f9f";
                var x1 = cpos(10489600);
                var x2 = cpos(10489620);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("NB digi",cpos(10489602),15);
                
                // digital
                ctx.fillStyle = "#febf00";
                var x1 = cpos(10489620);
                var x2 = cpos(10489640);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("digital",cpos(10489624),15);
                
                // mixed
                ctx.fillStyle = "#c55910";
                var x1 = cpos(10489640);
                var x2 = cpos(10489690);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("MIXED modes",cpos(10489650),15);
                
                // SSB
                ctx.fillStyle = "#91cf4f";
                var x1 = cpos(10489690);
                var x2 = cpos(10489795);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("SSB only",cpos(10489730),15);
            }
            
            var wfcolor = "red";
            var linethickness = 1;
            var next_linethickness = 1;
            var sockurl = '?';
            
            function draw_tune()
            {
                // Get the WF canvas and WF context
                var c = document.getElementById('tune');
                var ctx = c.getContext('2d');
                
                var x = foffset / resolution;
                x = x/2;
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0,0,c.width,c.height);
                
                ctx.fillStyle = '#00c000';
                ctx.fillRect(x,0,20,c.height);
            }
            
            var specarrlen = 8;
            var midarr = new Array(200);
            var peakarr;
            var arrfirst = 1;
            var speclevel = -180;
            var specgain = -60;
            var audiogain = 50;
            var wflevel = 230;
            var wfgain = 50;
			var bcnarrlen = 500;
			var beaconarr = new Array(bcnarrlen);
			var bcnarrempty = 1;
            var maxval = -999999;
            var minval = 999999;
            
            function draw_spec()
            {
                // get the elemt IDs and dimensions
                var canvas = document.getElementById("spec"); 
                var context = canvas.getContext("2d");
                var width = canvas.width;
                var height = canvas.height;
                
                // variables to store min/max values for this single path
                var n_maxval = -999999;
                var n_minval = 999999;
				var beacon_maxval = -999999;
				var beacon_mid_maxval = -999999;
				
				// variable to calculate lowest 0dB position
				var mittel = 0;
				
				// NB-Transponder, position of beacons
                var xm1 = cpos(10489547);
                var xm2 = cpos(10489553);
                var xm3 = cpos(10489797);
                var xm4 = cpos(10489803);

                // storage for the dB value for each horizontal pixel
                // used for dB label
                var pntarr = new Array(width);
                
                // draw background
                context.fillStyle = '#404040';
                context.fillRect(0,0,width,height);
                
                // set colors of spectrum lines and fill
                context.strokeStyle = '#ffffff';
                context.fillStyle = '#c0c0c0';
                
                // midarr is used to calculate the mean value according
                // to the Average-Slider setting
                // generate and initialize the array
                if(arrfirst == 1)
                {
                    peakarr = new Array(width);
                    for(var x=0; x<width; x++)
                    {
                        peakarr[x] = -200;
                    }
                    
                    for(var i=0; i<200; i++)
                    {
                        midarr[i] = new Array(width);
                        for(var x=0; x<width; x++)
                        {
                            midarr[i][x] = -pix[x];
                        }
                    }
                    arrfirst = 0;
                }

                // draw spectrum as a filled area
				// start drawing in left-bottom corner
                context.beginPath();
                context.moveTo(0, height-1);

                // loop through all horizontal pixels
                for(var x=0; x<width; x++)
                {
                    if(trace_mode == 0)
                    {
                        // Averaging mode
                        // calculate the average value, first
                        // shift the array and put new data at the beginning
                        for(var idx=(specarrlen-1); idx>=1; idx--)
                            midarr[idx][x] = midarr[idx-1][x];
                        // add new value
                        midarr[0][x] = -pix[x];
                        
                        // calculate the average
                        var mv = 0; // mid value
                        for(var idx=0; idx<specarrlen; idx++)
                            mv += midarr[idx][x];
                        mv /= specarrlen;
                    }
                    
                    if(trace_mode == 1)
                    {
                        // Peak mode
                        // use only the first cell [0] of midarr
                        // put the maximum value here
                        var newval = -pix[x];
                        if(newval > peakarr[x])
                            peakarr[x] = newval;
                        
                        mv = peakarr[x];
                    }
                    // mv is now the dB value of the signal at position x
                    
                    // find the highest value, excluding the beacons
                    // which is the highest user level (n_maxval)
                    if(mv > n_maxval && (x < xm1 || x > xm4 || (x > xm2 && x < xm3)))
                        n_maxval = mv;

					// find the highest value of the beacons
					if(mv > beacon_maxval && ((x > xm1 && x < xm2) || (x > xm3 && x < xm4)))
						beacon_maxval = mv;
						
					// sum all values for the mean value calculation
                    mittel += mv;
                    
                    // find the minumim value
                    if(mv < n_minval)
                      n_minval = mv;
                        
                    // draw the spectrum line
                    context.lineTo(x,scale(mv));

					// add value to end of array (used for dB-Labels)
					pntarr[x] = mv;
					//pntarr.push(mv);
                }
                
                // mean value calculation
                // in the NB transponder this value is a little bit over the noise level
                mittel /= width;

                // finish the spectrum display by closing and filling the area
                context.lineTo(width-1,height-1);
                context.fill();
                context.stroke();
                
                // change minval only if bigger difference to old value to avaiod flickering
                if(Math.abs(minval - n_minval) > 0.6)
                {
                    minval = n_minval;
                }
                maxval = n_maxval;
                
                // now the spectrum is drawn, make the nice features, lables ...

                // maximum allowed power level marker
				// draw a red line at highest beacon level of the last bcnarrlen measurements
				if(beacon_maxval > -200)    // only is valid values are available
				{
                    // the beacon level must be stored for a longer time (see bcnarrlen)
                    // to ignore fading and CW, just find the maximum values
					if(bcnarrempty == 1)
					{
						bcnarrempty = 0;
						// init beaconarr
						for(var d=0; d<bcnarrlen; d++)
							beaconarr[d] = beacon_maxval;
					}
					else
					{
                        // store beacon levels in an array
						for(var d=(bcnarrlen-1); d>=1; d--)
			                beaconarr[d] = beaconarr[d-1];
						beaconarr[0] = beacon_maxval;
					}

					// find the maximum beacon level, which is the max. allowed power level
					beacon_mid_maxval = -999999;
					for(var d=0; d<bcnarrlen; d++)
					{
						if(beaconarr[d] > beacon_mid_maxval)
							beacon_mid_maxval = beaconarr[d];
					}

 					// ybcn is the Y-pixel position of the beacon level
					ybcn = scale(beacon_mid_maxval);

		            // double hor red line at beacon value
		            context.strokeStyle = '#ff0000';
		            context.beginPath();
		            context.moveTo(0, ybcn);
		            context.lineTo(width-1, ybcn);
		            context.stroke();

					context.strokeStyle = '#ff0000';
		            context.beginPath();
		            context.moveTo(0, ybcn-1);
		            context.lineTo(width-1, ybcn-1);
		            context.stroke();

		            // label for beacon level
		            var dynrange = beacon_mid_maxval - minval;
		            context.font = "12px Arial";
		            context.fillStyle = "#ffc0c0";
		            context.fillText("+" + dynrange.toFixed(0) + " dB",10,ybcn+10);
					context.fillText("max. beacon level",10,ybcn-5);
				}
                
                // hor line at highest value, except the beacon
                // highest user level
                context.strokeStyle = '#008080';
                context.beginPath();
                context.moveTo(0, scale(maxval));
                context.lineTo(width-1, scale(maxval));
                context.stroke();

   				// write dB value to max line
                var dynrange = maxval - minval;
                context.font = "12px Arial";
                context.fillStyle = "#ffc0c0";
                context.fillText("+" + dynrange.toFixed(0) + " dB",10,scale(maxval)+10);

                // hor line at lowest value (between mid value and lowest value)
                // the is the bottom noise floor level
                var yvalue = minval+(mittel-minval)*3/4;
                context.strokeStyle = '#80ff80';
                context.beginPath();
                context.moveTo(0, scale(yvalue));
                context.lineTo(width-1, scale(yvalue));
                context.stroke();

				// write dB value to every peak which is > 15dB over min
				// draw max. 20 peak labels
				var maxv = 0;
				var maxx = 0;
				for(var pk=0; pk<20; pk++)
				{
					maxv = 0;
					maxx = 0;
					for(var x=10; x<(width-10); x++) // not at the margins
					{
						var dval = pntarr[x] - minval;
						// seek max. value
						if(dval > maxv) 
						{
							maxv = dval;
							maxx = x;
						}
					}
					if(maxv < 15) break;	// only values >15dB over minval
					// max value is at position maxx
					// draw the label
					context.fillText(maxv.toFixed(0) + " dB",maxx,scale(pntarr[maxx]));
					// clear the values +-10 of this max value
					for(var c = (maxx-10); c < (maxx+10); c++)
					{
						if(c>=0 && c<width)
							pntarr[c] = minval;
					}
				}

                // vertical lines for QO-100 mode ranges
                if(vertlines == 1)
                {
                    vertline(10489550);
                    vertline(10489600);
                    vertline(10489620);
                    vertline(10489640);
                    vertline(10489690);
                    vertline(10489800);
                }
                
                // the spctrum display is drawn
                
                // do the calculations for the automatic level and gain settings
                var ckb = $("#spekautolevel").is(':checked');
                if(ckb && minval < 0)    // ignore invalid values
                {
                    // calculate speclevel and specgain so that
                    // minval goes to y=(height-5) and maxval goes to y=15
                    var ymin = 145; // min/max positions in screen coordinates
                    var ymax = 15;
                    var maxv = maxval;
                    if(beacon_mid_maxval > maxval)
                        maxv = beacon_mid_maxval;
                    var a = (height - ymin)/height;
                    var b = (height - ymax)/height;
                    specgain =(minval*(b-1)-maxv*(a-1))/(a*(b-1)-b*(a-1));
                    speclevel = (a*specgain-minval)/(a-1);
                    
                    // adjust WF parameters
                    wflevel = 230;
                    wfgain = 50;

                    //console.log("speclevel:"+speclevel+" minval:"+minval + "specgain:"+specgain+" maxval:"+maxval);
                    
                    var slider_speclevel = document.getElementById("speclevel");
                    slider_speclevel.value = speclevel;
                    
                    var slider_specgain = document.getElementById("specgain");
                    slider_specgain.value = specgain;
                    
                    var slider_wflevel = document.getElementById("wflevel");
                    slider_wflevel.value = wflevel;
                    
                    var slider_wfgain = document.getElementById("wfgain");
                    slider_wfgain.value = wfgain;
                }

                // helper functions
                // scale dBm value to y-pixelpos
                function scale(v)
                {
                    var y = -height*(v-speclevel)/(specgain-speclevel) + height;
                    return y;
                }
                
                function vertline(qrg)
                {
                    var x = cpos(qrg);
                
                    context.strokeStyle = '#4040c0';
                    context.beginPath();
                    context.moveTo(x, 0);
                    context.lineTo(x, height-1);
                    context.stroke();
                }
            }
            
            var arrmidlen = 20;
            var cmaxvalarr = new Array(arrmidlen);
            var cminvalarr = new Array(arrmidlen);
            var cmaxval;
            var cminval;

            var hWFrefval = 50;     // shifts the black value (higher=darker)
            var hWFgain = 0.00001;   // contrast (must be > 0, low=high contrast)

            var minlog;
            var factor;
            var frs = 1;

            // find min/max the values of one pixel line
            function calcColorParms(d, len)
            {
                var max = -9999;
                var min = 9999;
                
                for(var i=0; i<len; i++)
                {
                    // d[i] is the dBm value at the antenna input (if calibrated and AGC off)
                    // it is a negative value, max range: -180 ... 0
                    if(d[i] < min) min = d[i];
                    if(d[i] > max) max = d[i];
                }
                
                if(frs)
                {
                    // init array
                    frs=0;
                    for(var i=0; i<arrmidlen; i++)
                    {
                        cminvalarr[i] = min;
                        cmaxvalarr[i] = max;
                    }
                }
                
                // insert into mid array
                for(var i=(arrmidlen-1); i>=1; i--)
                {
                    cminvalarr[i] = cminvalarr[i-1];
                    cmaxvalarr[i] = cmaxvalarr[i-1];
                }
                cminvalarr[0] = min;
                cmaxvalarr[0] = max;
                
                cminval  = 0;
                cmaxval = 0;
                for(var i=0; i<arrmidlen; i++)
                {
                    cminval += cminvalarr[i];
                    cmaxval += cmaxvalarr[i];
                }
                cminval /= arrmidlen;
                cmaxval /= arrmidlen;
                
                cminval = -cminval;
                cmaxval = -cmaxval;
                
                // prepare values used my getPixelColor
                factor = hWFgain/10;
                minlog = Math.log(factor + 1) / 255;
                
                //console.log("cminval:" + cminval + " cmaxval:" + cmaxval);
            }
            
            function getPixelColor(val)
            {
                // === black value, no signal, background noise ===
                // shift the value up, so that cminval is color=0
                val = -val;
                val -= cminval;
                val -= (hWFrefval/10);
                
                // === max level, strongest signal ===
                // make the loudest signal to 255
                // shift cmaxval the same factor as the signal value, so both start at 0
                var cmax = (cmaxval - cminval);
                // expand the signal value so that the maxval is 255
                // do this with a log formular, high values are more effected
                var lin = val * factor / cmax;
                var revlin = factor - lin + 1;
                var mylog = Math.log(revlin);
                var logTo255 = mylog/ minlog;
                //var val1 = 255 - logTo255;
                var val1 = logTo255;
                
                // low colors reserver for other purposes
                if (val1 <= 2) val1 = 3;
                if (val1 > 250) val1 = 255;
                return val1;
            }
            
            function drawWF()
            {
                linethickness = next_linethickness;
                
                // Get the WF canvas and WF context
                var canvas = document.getElementById("wf"); 
                var context = canvas.getContext("2d");
            
                // Get the canvas dimensions
                var width = canvas.width;
                var height = canvas.height;
                
                // create a 1-line canvas for the new data
                var line_cnv = document.getElementById("makeline"); 
                var line_ctx = line_cnv.getContext("2d");
                var line_width = line_cnv.width;
                line_cnv.height = linethickness;
                var imagedata = line_ctx.createImageData(line_width, linethickness);
                // insert the new data into this line
                for( var y=0; y<linethickness; y++)
                {
                    calcColorParms(pix, line_width);
                    
                    var qrg = 0;
                    for (var x = 0; x < line_width; x++) 
                    {
                        var off = y*(line_width*4) + x*4;
                        
                        // pix[n] is the dBm value of the input signal (positive)
                        // it must be converted to the color table index
                        var pval = getPixelColor(pix[x]);
                        
                        // user adjustments
                        pval = pval * (Number(wfgain)/50) + (Number(wflevel) -200);
                        pval = pval.toFixed(0);
                        if(pval < 3) pval = 3;
                        if(pval > 255) pval = 255;
                        
                        if(wfcolor == "red")
                        {
                            imagedata.data[off] = 256*(coltab[pval][0]);
                            imagedata.data[off+1] = 256*(coltab[pval][1]);
                            imagedata.data[off+2] = 256*(coltab[pval][2]);
                        }
                        if(wfcolor == "green")
                        {
                            imagedata.data[off] = 256*(coltab[pval][1]);
                            imagedata.data[off+1] = 256*(coltab[pval][0]);
                            imagedata.data[off+2] = 256*(coltab[pval][2]);
                        }
                        if(wfcolor == "blue")
                        {
                            imagedata.data[off] = 256*(coltab[pval][2]);
                            imagedata.data[off+1] = 256*(coltab[pval][1]);
                            imagedata.data[off+2] = 256*(coltab[pval][1]);
                        }
                        if(wfcolor == "white")
                        {
                            imagedata.data[off] = 256*(coltab[pval][0]);
                            imagedata.data[off+1] = 256*(coltab[pval][0]);
                            imagedata.data[off+2] = 256*(coltab[pval][0]);
                        }
                        imagedata.data[off+3] = 255;
                        
                        qrg += resolution;
                    }
                }
                // and draw it into the 1-line canvas
                line_ctx.putImageData(imagedata, 0, 0);
                
                // now draw the 1-line canvas followed by the old WF canvas
                // this automatically shifts the old picture down one line
                context.drawImage(line_cnv, 0, 0);
                context.drawImage(canvas, 0, linethickness);
            }
            
            function drawOverlay()
            {
                var canvas = document.getElementById("wf_overlay"); 
                var context = canvas.getContext("2d");
            
                // Get the canvas dimensions
                var width = canvas.width;
                var height = canvas.height;
                
                context.clearRect(0,0,width,height);

                var ImageData = context.getImageData(0,0,width,height);

                if(vertmarker == 1)
                {
                
                    // draw transparent rectangle at the zoomed qrg range
                    for(var i=0; i<height; i++)
                    {
                        // right part USB
                        for(var j=calcpos(end1/2); j<calcpos(end1);j++)
                        {
                            ImageData.data[((i*(width*4)) + (j*4) + 0)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 1)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 3)] = 50;
                        }
                        
                        // left part LSB
                        for(var j=calcpos(0); j<calcpos(end1/2);j++)
                        {
                            ImageData.data[((i*(width*4)) + (j*4) + 0)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 1)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 3)] = 20;
                        }
                    }
                    
                    // make a vertical line in the middle (which is the carrier frequency)
                    j = calcpos(0 + end1/2);
                    for(var i=0; i<height; i++)
                    {
                        ImageData.data[((i*(width*4)) + (j*4) + 0)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 1)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 3)] = 80;
                    }
                }
                
                if(vertlines == 1)
                {
                    // draw es'hail-2 vertical lines
                    function vl(xpos,i)
                    {
                        var j = cpos(xpos);
                        ImageData.data[((i*(width*4)) + (j*4) + 0)] = 100;
                        ImageData.data[((i*(width*4)) + (j*4) + 1)] = 100;
                        ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 3)] = 255;
                    }
                    
                    for(var i=0; i<height; i++)
                    {
                        vl(10489555,i);
                        vl(10489600,i);
                        vl(10489620,i);
                        vl(10489640,i);
                        vl(10489690,i);
                        vl(10489795,i);
                    }
                }
                context.putImageData(ImageData,0,0);
            }
            
            function drawOverlay1()
            {
                var canvas = document.getElementById("wf1_overly"); 
                var context = canvas.getContext("2d");
            
                // Get the canvas dimensions
                var width = canvas.width;
                var height = canvas.height;
                
                context.clearRect(0,0,width,height);

                var ImageData = context.getImageData(0,0,width,height);
                
                if(vertlines == 1)
                {
                    // draw es'hail-2 vertical lines
                    function vl(xpos,i)
                    {
                        var j = xpos;
                        ImageData.data[((i*(width*4)) + (j*4) + 0)] = 100;
                        ImageData.data[((i*(width*4)) + (j*4) + 1)] = 100;
                        ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 3)] = 255;
                    }
                    
                    function vls(xpos,i)
                    {
                        var j = xpos;
                        ImageData.data[((i*(width*4)) + (j*4) + 0)] = 100;
                        ImageData.data[((i*(width*4)) + (j*4) + 1)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 3)] = 255;
                    }
                    
                    for(var i=0; i<height; i++)
                    {
                        // 0 Hz line
                        vl(width/2,i);
                        
                        // SSB lines 200 Hz and Filter-Cutoff line
                        if((i%2)==0)
                        {
                            vls(width/2 + 20,i);
                            vls(width/2 + filter_cutoff/10,i);
                        }
                    }
                }
                context.putImageData(ImageData,0,0);
            }
            
            function drawWF1()
            {
                linethickness = next_linethickness;
                
                // Get the WF canvas and WF context
                var canvas1 = document.getElementById("wf1"); 
                var context1 = canvas1.getContext("2d");
            
                // Get the canvas dimensions
                var width1 = canvas1.width;
                var height1 = canvas1.height;
                
                // create a 1-line canvas for the new data
                var line_cnv1 = document.getElementById("makeline1"); 
                var line_ctx1 = line_cnv1.getContext("2d");
                var line_width1 = line_cnv1.width;
                line_cnv1.height = linethickness;
                var imagedata1 = line_ctx1.createImageData(line_width1, linethickness);
                // insert the new data into this line
                for( var y=0; y<linethickness; y++)
                {
                    var qrg = 0;
                    for (var x = 0; x < line_width1; x++) 
                    {
                        var off = y*(line_width1*4) + x*4;
                        
                        var pval = getPixelColor(pix1[x]);
                        pval = pval * (Number(wfgain)/50) + (Number(wflevel) - 200);
                        pval = pval.toFixed(0);
                        if(pval < 3) pval = 3;
                        if(pval > 255) pval = 255;
                        
                        if(wfcolor == "red")
                        {
                            imagedata1.data[off] = 256*(coltab[pval][0]);
                            imagedata1.data[off+1] = 256*(coltab[pval][1]);
                            imagedata1.data[off+2] = 256*(coltab[pval][2]);
                        }
                        if(wfcolor == "green")
                        {
                            imagedata1.data[off] = 256*(coltab[pval][1]);
                            imagedata1.data[off+1] = 256*(coltab[pval][0]);
                            imagedata1.data[off+2] = 256*(coltab[pval][2]);
                        }
                        if(wfcolor == "blue")
                        {
                            imagedata1.data[off] = 256*(coltab[pval][2]);
                            imagedata1.data[off+1] = 256*(coltab[pval][1]);
                            imagedata1.data[off+2] = 256*(coltab[pval][1]);
                        }
                        if(wfcolor == "white")
                        {
                            imagedata1.data[off] = 256*(coltab[pval][0]);
                            imagedata1.data[off+1] = 256*(coltab[pval][0]);
                            imagedata1.data[off+2] = 256*(coltab[pval][0]);
                        }
                        imagedata1.data[off+3] = 255;
                        
                        qrg += resolution1;
                    }
                }
                // and draw it into the 1-line canvas
                line_ctx1.putImageData(imagedata1, 0, 0);
                
                // now draw the 1-line canvas followed by the old WF canvas
                // this automatically shifts the old picture down one line
                context1.drawImage(line_cnv1, 0, 0);
                context1.drawImage(canvas1, 0, linethickness);
            }
            
            // calc px-pos of an offset of WF1 in WF
            function calcpos(x_wf1)
            {
                var A = tuneqrg;
                var B = tuneqrg+end/1000;
                var f = tuneqrg1+(x_wf1-7500)/1000;
                
                var res = 1500 * (f-A)/(B-A);
                
                return Math.floor(res);
            }
            
            function cpos(x)
            {
                var A = tuneqrg;
                var B = tuneqrg+end/1000;
                
                var res = 1500 * (x-A)/(B-A);
                
                return Math.floor(res);
            }
            

            
            function drawConnect()
            {
                var canvas = document.getElementById("connect"); 
                var context = canvas.getContext("2d");
            
                // Get the canvas dimensions
                var width = canvas.width;
                var height = canvas.height;
                
                context.fillStyle = '#ffffff';
                context.fillRect(0,0,width,height);
                
                context.strokeStyle = '#000000';
                context.fillStyle = '#8080ff';
                
                context.beginPath();
                
                context.moveTo(0, height-1);
                context.lineTo(calcpos(0), 1);
                context.lineTo(calcpos(end1), 1);
                context.lineTo(width-1, height-1);

                context.closePath();
                context.fill();
                
                context.stroke();
            }

            function get32(myarr)
            {
                var val = myarr[0];
                val <<= 8;
                val += myarr[1];
                val <<= 8;
                val += myarr[2];
                val <<= 8;
                val += myarr[3];
                return val;
            }
            
            var ftx = 8089500;
            var rflock = 0;

			// arr is an uint8 array containing the pixel data at arr+20
            // each value is 16 bit, MSB first, so in total 3000 bytes = 1500 fft values
            
            var rxpix = new Array();
			var rxpix1 = new Array();
            var log1122 = Math.log(1.122);
            var db_maxval = Math.log(32768.0*1500) / log1122;

            // fill pix with dBm values
            function scaledBm()
            {
                var idx = 0;
                for(var i=0; i<1500; i++)
                {
                    // reconstruct the fft value
                    var fftval = rxpix[idx++];
                    fftval <<= 8;
                    fftval += rxpix[idx++];
                    
                    // calculate the dBm value
                    if (fftval < 1) fftval = 1;    
        
                    var dval = Math.log(fftval) / log1122;
                    dval = dval - db_maxval;
                    pix[i] = -dval;
                }
            }

			function scaledBm1()
            {
                var idx = 0;
                for(var i=0; i<1500; i++)
                {
                    // reconstruct the fft value
                    var fftval = rxpix1[idx++];
                    fftval <<= 8;
                    fftval += rxpix[idx++];
                    
                    // calculate the dBm value
                    if (fftval < 1) fftval = 1;    
        
                    var dval = Math.log(fftval) / log1122;
                    dval = dval - db_maxval;
                    pix1[i] = -dval;
                }
            }
            
            function handle_type(type,arr,pos,len)
            {
                if(type == 0 && reload)
                {
                    var idx = pos+2;
                    rflock = arr[pos];
                    tunerqrg = get32(arr.slice(idx));       // real qrg of the SDR's hardware tuner in Hz
                    end = get32(arr.slice(idx+4));          // total width of the WF in Hz
                    //console.log("Breite:" + end);
                    tuneqrg = get32(arr.slice(idx+8));      // QRG of the left margin of the picture
                    resolution = get32(arr.slice(idx+12));  // Hz per pixel
                    foffset = get32(arr.slice(idx+16));     // offset of the RX (lower WF) freq to the SDR tuned freq
                    rxpix  = arr.slice(idx+20);
					scaledBm();
                    pixwidth = end / resolution;
                    
                    var fval = (tuneqrg + foffset/1000)/1e3;
                    var sd = "RX: " + fval.toFixed(6) + " MHz, TX: " + (fval-ftx/1000).toFixed(6) + " MHz";
                    $("#tuneinfo").html(sd);
                    
                    if(qrgfocus == 0)
                        $("#qrg").val(tunerqrg);
                    
                    drawWFtitle_eshail_rx("wf_title");
                    drawWFtitle_eshail_tx("wf_txtitle");
                    drawWFtitle_eshail_ssb("wf_title1",fval);
                    drawWFtitle_eshail_ssb("wf_txtit1",fval-ftx/1000);
                    drawMODEtitle("wf_mdtitle",tuneqrg,tuneqrg+end/1000,resolution);
                    drawWF();
                    draw_tune();
                    draw_spec();
                    drawOverlay();
                    reload = 0;
                }
                
                if(type == 1)
                {
                    var idx = pos + 2;
                    tunerqrg = get32(arr.slice(idx));
                    end1 = get32(arr.slice(idx+4));
                    tuneqrg1 = get32(arr.slice(idx+8));
                    resolution1 = get32(arr.slice(idx+12));
                    foffset1 = get32(arr.slice(idx+16));
                    rxpix1  = arr.slice(idx+20);
					scaledBm1();
                    pixwidth1 = end / resolution;
                    
                    drawWF1();
                    drawConnect();
                    drawOverlay1();
                }

                if(type == 2)
                {
                    if(playON == 1)
                    {
                        player.feed(arr.slice(pos,pos+len),audiogain);
                    }
                }
            }
            
            function showLock()
            {
                lk = "sync-ing ............";
                if(rflock == 1) lk = "LOCKED to CW beacon";
                if($("#sync").is(':checked') == false) lk = "off";
                $("#lockstat").html(lk);
            }
            
            var openintv;
            var openints = 0;
            function nowOpen()
            {
                switch(openints)
                {
                    case 0: websocket.send("ssbmode:1\0"); 
                            break;
                    case 1: checkQRG();
                            break;
                }
                
                openints++;
                if(openints == 2)
                    clearInterval(openintv);
            }

            function openWebSocket()
            {
                window.WebSocket = window.WebSocket || window.MozWebSocket;

                // get socket URL fromactual browser-URL
                var x = location.href;
                var a = x.split("/");
                var y = "?";
                for(var i=0; i<a.length; i++)
                {
                    if(a[i].length > 6)
                    {
                        y = a[i];
                        break;
                    }
                }
                var ya = y.split(":");
                sockurl = "ws://" + ya[0] + ":8091";
                //console.log(sockurl);
                //$('#myinfo').html(sockurl);
                websocket = new WebSocket(sockurl);
                websocket.binaryType = "arraybuffer";

                websocket.onopen = function () {
                    sockOpen = 1;
                    $("#status").html("Connected to: " + sockurl);
                    //alert("WebSocket is now OPEN");
                    openintv = setInterval(nowOpen, 500);
                };

                websocket.onerror = function () {
                    $("#status").html("Error ... reconnecting ...");
                    websocketclose();
                    sockOpen = 0;
                };
                
                websocket.onclose = function () {
                    $("#status").html("Disconnected ... connecting ...");
                    websocketclose();
                    sockOpen = 0;
                };

                websocket.onmessage = function (message) 
                {
                    var arr = new Uint8Array(message.data);
                    // handle first element
                    var pos = 0;
                    var type = arr[pos++];
                    var len = (arr[pos++] << 8);
                    len += arr[pos++];
                    
                    handle_type(type,arr,pos,len);
                    pos += len;

                    if(arr.length > pos)
                    {
                        // handle second element
                        var type = arr[pos++];
                        var len = (arr[pos++] << 8);
                        len += arr[pos++];
                        handle_type(type,arr,pos,len);
                        pos += len;
                    }

                    if(arr.length > pos)
                    {
                        // handle 3rd element
                        var type = arr[pos++];
                        var len = (arr[pos++] << 8);
                        len += arr[pos++];
                        handle_type(type,arr,pos,len);
                    }
                    // remark: window.requestAnimationFrame(drawWF); do NOT use this, high CPU load and corrupts picture if in background
                };
                
                // store settings and send to server
                $('#color').click(function(e) {
                    e.preventDefault();
                    wfcolor = $(this).children("option:selected").val();
                    localStorage.setItem('color',wfcolor);
                });
                
                $('#speed').click(function(e) {
                    e.preventDefault();
                    clearInterval(intv);
                    interval = $(this).children("option:selected").val();
                    intv = setInterval(reloadData, interval);
                    localStorage.setItem('speed',interval);
                });
                
                $('#yzoom').click(function(e) {
                    e.preventDefault();
                    next_linethickness = Number($(this).children("option:selected").val());
                    localStorage.setItem('yzoom',next_linethickness);
                });

                $('#yline').click(function(e) {
                    e.preventDefault();
                    vertlines = Number($(this).children("option:selected").val());
                    localStorage.setItem('ylines',vertlines);
                });

                $('#ymarker').click(function(e) {
                    e.preventDefault();
                    vertmarker = Number($(this).children("option:selected").val());
                    localStorage.setItem('ymarker',vertmarker);
                });
                
                $(document).ready(function(){
                $('#qrg').bind('mousewheel', function(e){
                        if($("#sync").is(':checked') == false)
                        {
                            $('#qrg').blur();
                            if(e.originalEvent.wheelDelta > 0) {
                                websocket.send("tunerfr:1\0");
                            }
                            else{
                                websocket.send("tunerfr:0\0");
                            }
                        }
                    });
                });
                
                $('#qrg').keyup(function(event){
                    var keycode = (event.keyCode ? event.keyCode : event.which);
                    if(keycode == '13'){
                        var qrgval = $('#qrg').val();
                        websocket.send("tunervl:" + qrgval + "\0");
                    }

                });
                
            }
            
            function checkQRG()
            {
                var ckb = $("#sync").is(':checked');
                $('#qrg').attr('disabled', ckb);
                if(ckb == true)
                    websocket.send("autosyn:1\0");
                else
                    websocket.send("autosyn:0\0");
            }
            
            function CATonoff()
            {
                var ckb = $("#catonoff").is(':checked');
                if(ckb == true)
                    websocket.send("catonof:1\0");
                else
                    websocket.send("catonof:0\0");
            }
            
            var trace_mode = 0; // 0=average, 1=peak
            
            function clickAverage()
            {
                var ckb = $("#average").is(':checked');
                if(ckb && trace_mode == 1)
                {
                    document.getElementById("peak").checked = false;
                    trace_mode = 0;
                    for(var x=0; x<(document.getElementById("spec").width); x++)
                    {
                        peakarr[x] = -200;
                    }
                }
            }
            
            function clickPeak()
            {
                var ckb = $("#peak").is(':checked');
                if(ckb && trace_mode == 0)
                {
                    document.getElementById("average").checked = false;
                    trace_mode = 1;
                }
            }
            
            function setListboxes()
            {
                var v = localStorage.getItem('color');
                if(v != null)
                {
                    wfcolor = v;
                    $('#color').val(wfcolor);
                }
                    
                v = localStorage.getItem('speed');
                if(v != null)
                {
                    interval = v;
                    clearInterval(intv);
                    intv = setInterval(reloadData, interval);
                    $('#speed').val(interval);
                }
                else
                {
                    intv = setInterval(reloadData, 10);
                }
                    
                v = localStorage.getItem('yzoom');
                if(v != null)
                {
                    next_linethickness = v;
                    $('#yzoom').val(next_linethickness);
                }
                    
                v = localStorage.getItem('ylines');
                if(v != null)
                {
                    vertlines = v;
                    $('#yline').val(vertlines);
                }
                    
                v = localStorage.getItem('ymarker');
                if(v != null)
                {
                    vertmarker = v;
                    $('#ymarker').val(vertmarker);
                }

                var slider_specmid = document.getElementById("specmid");
                v = localStorage.getItem('specmid');
                if(v != null)
                {
                    specarrlen = v;
                    slider_specmid.value = specarrlen;
                }
                
                slider_specmid.oninput = function() 
                {
                    specarrlen = this.value;
                    if(specarrlen <= 0) specarrlen = 1;
                    localStorage.setItem('specmid',specarrlen);
                }
                
                var slider_speclevel = document.getElementById("speclevel");
                v = localStorage.getItem('speclevel');
                if(v != null)
                {
                    speclevel = v;
                    slider_speclevel.value = speclevel;
                }
                    
                slider_speclevel.oninput = function() 
                {
                    speclevel = this.value;
                    if(Number(speclevel) > Number(specgain)) specgain = Number(speclevel) + 10.0;
                    localStorage.setItem('speclevel',speclevel);
                    
                }
                
                var slider_specgain = document.getElementById("specgain");
                v = localStorage.getItem('specgain');
                if(v != null)
                {
                    specgain = v;
                    slider_specgain.value = specgain;
                }
                    
                slider_specgain.oninput = function() 
                {
                    specgain = this.value;
                    if(Number(specgain) < Number(speclevel)) speclevel = Number(specgain) - 10.0;
                    localStorage.setItem('specgain',specgain);
                }
                
                var slider_audiogain = document.getElementById("audiogain");
                v = localStorage.getItem('audiogain');
                if(v != null)
                {
                    audiogain = v;
                    slider_audiogain.value = audiogain;
                }
                    
                slider_audiogain.oninput = function() 
                {
                    audiogain = this.value;
                    localStorage.setItem('audiogain',audiogain);
                }
                
                var checkbox_autolevel = document.getElementById("spekautolevel");
                var v1x = localStorage.getItem('spekautolevelx');
                if(v1x != null)
                {
                    if(v1x == 0)
                        checkbox_autolevel.checked = false;
                    else
                        checkbox_autolevel.checked = true;
                }
                
                checkbox_autolevel.onclick = function() 
                {
                    autoclk = this.checked;
                    if(this.checked)
                        localStorage.setItem('spekautolevelx',1);
                    else
                        localStorage.setItem('spekautolevelx',0);
                }
                
                var slider_wflevel = document.getElementById("wflevel");
                v = localStorage.getItem('wflevel');
                if(v != null)
                {
                    wflevel = v;
                    slider_wflevel.value = wflevel;
                }
                    
                slider_wflevel.oninput = function() 
                {
                    wflevel = this.value;
                    
                    localStorage.setItem('wflevel',wflevel);
                }
                
                var slider_wfgain = document.getElementById("wfgain");
                v = localStorage.getItem('wfgain');
                if(v != null)
                {
                    wfgain = v;
                    slider_wfgain.value = wfgain;
                }
                    
                slider_wfgain.oninput = function() 
                {
                    wfgain = this.value;
                    //console.log(wfgain);
                    localStorage.setItem('wfgain',wfgain);
                }
            }
            
            var qrgfocus = 0;
            function qrgFocusOut()
            {
                qrgfocus = 0;
            }
            
            function qrgFocus()
            {
                qrgfocus = 1;
            }
            
        </script>
        </head>
    <body>
        <div class="header_mytitle" id="header_mytitle">QO-100 on es'hail-2 NB-Transponder SSB Live Stream</div>
        <div class="header_subtitle" id="header_subtitle">for SDRplay RSP1a and RTL-SDR by DJ0ABR V1.5</div>
        <div class="controls">
            <div class="leftside">
                <select id="color" class="selectbox" name="color">
                    <option value="red">red</option>
                    <option value="green">green</option>
                    <option value="blue">blue</option>
                    <option value="white">white</option>
                </select>
                <select id="speed" class="selectbox" name="speed">
                    <option value="10">full speed</option>
                    <option value="200">200ms</option>
                    <option value="300">300ms</option>
                    <option value="500">500ms</option>
                    <option value="750">750ms</option>
                    <option value="1000">1s</option>
                    <option value="2000">2s</option>
                    <option value="4000">4s</option>
                </select>
                <select id="yzoom" class="selectbox" name="yzoom">
                    <option value="1">1 pixel/line</option>
                    <option value="2">2 pixel/line</option>
                    <option value="3">3 pixel/line</option>
                    <option value="4">4 pixel/line</option>
                    <option value="5">5 pixel/line</option>
                    <option value="6">6 pixel/line</option>
                    <option value="7">7 pixel/line</option>
                    <option value="8">8 pixel/line</option>
                    <option value="9">9 pixel/line</option>
                    <option value="10">10 pixel/line</option>
                </select>
                <select id="yline" class="selectbox" name="yline">
                    <option value="1">QRG line ON</option>
                    <option value="0">QRG line OFF</option>
                </select>
                <select id="ymarker" class="selectbox" name="ymarker">
                    <option value="1">Marker ON</option>
                    <option value="0">Marker OFF</option>
                </select>
                <button class="mybutton" id="audiobutton" onclick="audioON()">AUDIO OFF</button>
                <button class="mybutton" onclick="filter18()">1.8kHz</button>
                <button class="mybutton" onclick="filter24()">2.4kHz</button>
                <button class="mybutton" onclick="filter28()">2.8kHz</button>
                <button class="mybutton" onclick="filter30()">3.0kHz</button>
                <button class="mybutton" onclick="filter36()">3.6kHz</button>
                <div class="controls_left">
                    <div class="controls_left_left">
                        <div>QRG-AUTOLOCK:</div>
                        <div>SDR-SERVER:</div>
                    </div>
                    <div class="controls_left_mid">
                        <div id="lockstat">Lockstatus</div>
                        <div id="status">Status</div>
                    </div>
                    <div class="controls_left_right">
                        <div><input type="checkbox" id="sync" onclick="checkQRG()">Sync ON/off</div>
                        <div><input type="text" class="qrg" id="qrg" onfocusout="qrgFocusOut()"  onfocus="qrgFocus()">  Hz (Tuner)</div>
                    </div>
                </div>
            </div>
            
            <div class="rl_space">
            </div>
            <div class="midside">
                <div class="rightrow">
                    <div class="rightcell_label_header" style="display: flex;">
                        <div style="width:150px;">
                            Spectrum:
                        </div>
                        <div style="width:100px;font-size:14px;font-weight: 300;">
                            <label for="spekautolevel">
                                Auto:<input type="checkbox" id="spekautolevel">
                            </label>
                        </div>
                    </div>
                    <div class="rightcell_slider">
                    </div>
                    <div class="rightcell_label_header">
                        Waterfall:
                    </div>
                    <div class="rightcell_slider">
                    </div>
                </div>
                <div class="rightrow_space">
                </div>
                <div class="rightrow">
                    <div class="rightcell_label">
                        Level:
                    </div>
                    <div class="rightcell_slider">
                        <input id="speclevel" type="range" min="-180" max="-20" value="-180" style="direction: rtl;">                        
                    </div>
                    <div class="rightcell_label">
                        Level:
                    </div>
                    <div class="rightcell_slider">
                        <input id="wflevel" type="range" min="50" max="350" value="230">
                    </div>
                </div>
                <div class="rightrow">
                    <div class="rightcell_label">
                        Gain:
                    </div>
                    <div class="rightcell_slider">
                        <input id="specgain" type="range" min="-100" max="0" value="-60" style="direction: rtl;">
                    </div>
                    <div class="rightcell_label">
                        Gain:
                    </div>
                    <div class="rightcell_slider">
                        <input id="wfgain" type="range" min="20" max="100" value="50">
                    </div>
                </div>
                <div class="rightrow">
                    <div class="rightcell_label">
                        Average:
                    </div>
                    <div class="rightcell_slider">
                        <input id="specmid" type="range" min="1" max="20" value="10">
                    </div>
                    <div class="rightcell_label">
                        Audio:
                    </div>
                    <div class="rightcell_slider">
                        <input id="audiogain" type="range" min="1" max="100" value="50">
                    </div>
                </div>
                <div class="rightrow" style="background-color: #e0e0e0;">
                    <div style="width: 230px;">
                        spectrum trace mode:
                    </div>
                    <div style="width: 150px;">
                        <input type="checkbox" id="average" onclick="clickAverage()" checked>Average
                    </div>
                    <div style="width: 180px;">
                        <input type="checkbox" id="peak" onclick="clickPeak()">Peak Hold
                    </div>
                </div>
            </div>
            <div class="rl_space">
            </div>
            <div class="rightside">
                <div>
                    <input type="checkbox" id="catonoff" onclick="CATonoff()">Icom CAT
                </div>
                <div>
                </div>
                <div>
                </div>
                <div id="mousepos"></div>
				<p style="color:red">if Icom CAT active:<br>remote control only for local stations !<br>No access from internet</p>
            </div>
        </div>
        
        <div id="tuneinfo" class="tuneinfo">Tuner</div>
        <br>
        
        <div style="position: relative;">
            <canvas id="wf_title"   width="1500" height="20"  style="position: absolute; left: 0; top: 0px; z-index: 0;"></canvas>
            <canvas id="wf_txtitle" width="1500" height="20"  style="position: absolute; left: 0; top: 20px; z-index: 0;"></canvas>
            <canvas id="spec"       width="1500" height="150" style="position: absolute; left: 0; top: 40px; z-index: 0;"></canvas>
            <canvas id="wf_mdtitle" width="1500" height="20"  style="position: absolute; left: 0; top: 190px; z-index: 0;"></canvas>
            <canvas id="tune"       width="1500" height="5"   style="position: absolute; left: 0; top: 210px; z-index: 0;"></canvas>
            <canvas id="wf_overlay" width="1500" height="300" style="position: absolute; left: 0; top: 215px; z-index: 1;"></canvas>
            <canvas id="wf"         width="1500" height="300" style="position: absolute; left: 0; top: 215px; z-index: 0;"></canvas>
            <canvas id="connect"    width="1500" height="30"  style="position: absolute; left: 0; top: 515px; z-index: 0;"></canvas>
            <canvas id="wf_title1"  width="1500" height="20"  style="position: absolute; left: 0; top: 545px; z-index: 0;"></canvas>
            <canvas id="wf_txtit1"  width="1500" height="20"  style="position: absolute; left: 0; top: 565px; z-index: 0;"></canvas>
            <canvas id="wf1_overly" width="1500" height="150" style="position: absolute; left: 0; top: 586px; z-index: 1;"></canvas>
            <canvas id="wf1"        width="1500" height="150" style="position: absolute; left: 0; top: 586px; z-index: 0;"></canvas>
            <canvas id="makeline"   width="1500" height="10"  style="display:none"></canvas>
            <canvas id="makeline1"  width="1500" height="10"  style="display:none"></canvas>
        </div>
        
    </body>
</html>

